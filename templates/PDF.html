<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 论文元数据提取器 - 控制面板</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ========== 全局与卡片风格 ========== */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #111827;
        }
        .bento-box {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 6px 18px -10px rgba(17, 24, 39, 0.25);
            padding: 1.25rem;
            transition: box-shadow .25s ease, transform .25s ease, border-color .25s ease;
        }
        .bento-box:hover {
            box-shadow: 0 12px 28px -14px rgba(17, 24, 39, 0.32);
            border-color: #e2e8f0;
        }

        .log-container::-webkit-scrollbar,
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .log-container::-webkit-scrollbar-track,
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 999px;
        }
        .log-container::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 999px;
        }
        .log-container::-webkit-scrollbar-thumb:hover,
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ========== 表格整体布局优化 ========== */
        .table-container {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
            overflow: auto;
            max-height: 70vh;
        }

        .results-table {
            table-layout: fixed; /* 固定布局，避免列抖动 */
            width: 100%;
            border-collapse: separate;      /* 使用分离边框提升清晰度 */
            border-spacing: 0;              /* 取消默认间距 */
            font-size: 0.95rem;             /* 微调字号 */
        }

        /* 表头：粘性 + 层级感 + 视觉分隔 */
        .results-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(180deg,#f8fafc 0%,#f1f5f9 100%); /* 淡渐变更易读 */
            font-weight: 600;
            color: #334155;
            letter-spacing: .02em;
            text-transform: uppercase;
            border-bottom: 2px solid #e5e7eb;
            padding: 10px 14px;
            white-space: nowrap;
        }

        /* 单元格基础样式：更舒展的行高与内边距 */
        .results-table td {
            padding: 10px 14px;
            vertical-align: top;
            line-height: 1.55;
            color: #0f172a;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            border-bottom: 1px solid #f1f5f9;
            max-width: 0; /* 配合table-layout: fixed */
        }

        /* 斑马纹与悬停高亮（仅样式，不改变功能） */
        .results-table tbody tr:nth-child(odd) td {
            background-color: #fcfcfe;
        }
        .results-table tbody tr:hover td {
            background-color: #f6f8fb;
        }

        /* 首尾圆角（滚动容器内更精致） */
        .results-table thead th:first-child { border-top-left-radius: 12px; }
        .results-table thead th:last-child  { border-top-right-radius: 12px; }
        .results-table tbody tr:last-child td:first-child { border-bottom-left-radius: 12px; }
        .results-table tbody tr:last-child td:last-child  { border-bottom-right-radius: 12px; }

        /* ========== 列宽策略（更合理的比例） ========== */
        .col-filename { width: 14%; }
        .col-title { width: 26%; }
        .col-author { width: 16%; }
        .col-affiliation { width: 18%; }
        .col-email { width: 14%; }
        .col-keywords { width: 18%; }
        .col-abstract { width: 28%; }
        .col-acknowledgment { width: 28%; }
        .col-order { width: 14%; }

        /* 长文本：更友好的滚动与渐隐边缘，不遮挡文字 */
        .long-text {
            max-height: 140px;
            overflow-y: auto;
            padding-right: 8px;
            position: relative;
            mask-image: linear-gradient(180deg, rgba(0,0,0,1) 80%, rgba(0,0,0,0.55) 95%, rgba(0,0,0,0) 100%);
        }

        /* 长文本滚动条微调（与容器一致） */
        .long-text::-webkit-scrollbar {
            width: 6px;
        }
        .long-text::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }
        .long-text::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 6px;
        }
        .long-text::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 头/尾隐藏的柔和阴影，暗示可滚动（纯样式，不是按钮） */
        .long-text::before,
        .long-text::after {
            content: "";
            position: sticky;
            left: 0;
            right: 0;
            height: 16px;
            display: block;
            pointer-events: none;
            z-index: 1;
        }
        .long-text::before {
            top: 0;
            background: linear-gradient(180deg, rgba(248,250,252,1), rgba(248,250,252,0));
        }
        .long-text::after {
            bottom: 0;
            background: linear-gradient(0deg, rgba(248,250,252,1), rgba(248,250,252,0));
        }

        /* 表头细节：小型字体在小屏更紧凑 */
        @media (max-width: 768px) {
            .results-table { font-size: 0.9rem; }
            .results-table thead th { padding: 9px 10px; }
            .results-table td { padding: 9px 10px; }
        }

        /* --- 原有按钮风格（未改动功能） --- */
        .btn-primary {
            background-color: #E31937;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #c0122c;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-0.125rem);
        }
        .btn-primary:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            box-shadow: none;
            transform: translateY(0);
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-0.125rem);
        }
        .btn-secondary:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            box-shadow: none;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-7xl mx-auto">
        <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 左侧控制面板 -->
            <div class="bento-box md:col-span-1 flex flex-col gap-6">
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#E31937" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51h.01a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    <h2 class="text-2xl font-bold text-gray-800">控制面板</h2>
                </div>
                <div>
                    <label for="extractionMode" class="text-sm font-medium text-gray-600 mb-1 block">1. 选择提取模式</label>
                    <select id="extractionMode" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-700 focus:ring-2 focus:ring-[#E31937] focus:border-[#E31937] transition-colors">
                        <option value="sn">SN信息表收集</option>
                        <option value="ieee">IEEE信息表收集</option>
                        <option value="funding">资助信息提取</option>
                        <option value="ap">AP信息表收集</option>
                    </select>
                </div>
                <div>
                    <label for="pdfFiles" class="text-sm font-medium text-gray-600 mb-1 block">2. 选择 PDF 文件</label>
                    <input type="file" id="pdfFiles" multiple accept=".pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[#E31937]/10 file:text-[#E31937] hover:file:bg-[#E31937]/20 cursor-pointer">
                </div>
                <div class="mt-auto pt-6 border-t border-gray-200">
                    <label class="text-sm font-medium text-gray-600 mb-1 block">3. 开始处理</label>
                    <button id="startButton" class="btn-primary w-full">开始处理</button>
                    <div id="downloadLinkContainer" class="mt-3"></div>
                </div>
            </div>

            <!-- 右侧状态和日志 -->
            <div class="bento-box md:col-span-2 flex flex-col">
                 <div class="flex items-center gap-3 mb-4">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#E31937" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-activity"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    <h2 class="text-2xl font-bold text-gray-800">状态 & 日志</h2>
                </div>
                <div id="status" class="text-center font-medium text-gray-700 bg-gray-100 p-4 rounded-lg mb-4">
                    请选择文件并开始
                </div>
                <div id="logContainer" class="log-container flex-grow bg-gray-900 text-white font-mono text-sm p-4 rounded-lg overflow-y-auto h-96">
                    <p class="text-gray-400">&gt; 等待任务开始...</p>
                </div>
            </div>
        </main>

        <!-- 结果预览区（结构不变，仅样式更好看） -->
        <div id="resultsContainer" class="hidden mt-6">
            <div class="bento-box">
                <div class="flex items-center gap-3 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#E31937" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-grid"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <h2 class="text-2xl font-bold text-gray-800">处理结果预览</h2>
                </div>
                <div class="table-container overflow-x-auto">
                    <table id="resultsTable" class="results-table">
                        <thead>
                            <!-- 表头将由JS动态生成 -->
                        </thead>
                        <tbody>
                            <!-- 表格数据将由JS动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Excel文件生成已移至后端处理 ---

    // --- 后端服务地址（内置） ---
    const BACKEND_URL = '';

    // --- DOM 元素获取 ---
    const extractionModeSelect = document.getElementById('extractionMode');
    const pdfFilesInput = document.getElementById('pdfFiles');
    const startButton = document.getElementById('startButton');
    const downloadLinkContainer = document.getElementById('downloadLinkContainer');
    const statusDiv = document.getElementById('status');
    const logContainer = document.getElementById('logContainer');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsTable = document.getElementById('resultsTable');

    let processedDataForExcel = [];

    // --- 日志函数 ---
    function logMessage(message, type = 'info') {
        const p = document.createElement('p');
        let prefix = '&gt;';
        if (type === 'success') {
            p.className = 'text-green-400';
            prefix = '✅';
        } else if (type === 'error') {
            p.className = 'text-red-400';
            prefix = '❌';
        } else {
            p.className = 'text-gray-300';
        }
        p.innerHTML = `${prefix} ${message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`; // Basic sanitization
        logContainer.appendChild(p);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // --- 定义列排序函数 (支持两种模式) ---
    function getSortedHeaders(data, mode = 'sn') {
        const headerSet = new Set();
        data.forEach(row => {
            if (typeof row === 'object' && row !== null) {
                Object.keys(row).forEach(key => headerSet.add(key));
            }
        });

        const getHeaderRank = (header) => {
            if (mode === 'funding') {
                // 资助信息模式的列顺序
                const fundingOrder = ['文件名', '论文英文题目', '第一作者姓名', '第一作者单位', '通讯作者姓名', '通讯作者单位', '通讯作者邮箱', '关键词', '摘要', '致谢'];
                const index = fundingOrder.indexOf(header);
                if (index !== -1) return index;
            } else if (mode === 'ieee') {
                // IEEE模式的列顺序：订单号、英文题目、英文副标、作者姓名、第一作者邮箱
                const ieeeOrder = ['订单号', '英文题目', '英文副标', '作者姓名', '第一作者邮箱'];
                const index = ieeeOrder.indexOf(header);
                if (index !== -1) return index;
            } else if (mode === 'ap') {
                // AP模式的列顺序：文件名、题目、关键词、摘要、第一作者姓、第一作者名、通讯作者姓、通讯作者名
                const apOrder = ['文件名', '题目', '关键词', '摘要', '第一作者姓', '第一作者名', '通讯作者姓', '通讯作者名'];
                const index = apOrder.indexOf(header);
                if (index !== -1) return index;
            } else {
                // SN模式的列顺序
                const snOrder = ['Number', 'Title', 'SubTitle', 'Corresponding Author', "Corresponding author's email"];
                const index = snOrder.indexOf(header);
                if (index !== -1) return index;

                const authorMatch = header.match(/^Author (\d+)$/);
                if (authorMatch) return 100 + (parseInt(authorMatch[1], 10) * 2);

                const affilMatch = header.match(/^Affiliation (\d+)$/);
                if (affilMatch) return 100 + (parseInt(affilMatch[1], 10) * 2) + 1;
            }

            return 999; // 其他未知列排在最后
        };

        return [...headerSet].sort((a, b) => getHeaderRank(a) - getHeaderRank(b));
    }

    // --- 清理显示数据，移除内部处理字段（仅用于显示） ---
    function cleanDisplayData(data) {
        // 需要移除的内部字段（仅用于显示）
        const internalFields = new Set([
            '_original_index',
            '_upload_order',
            'attempt',
            'processing_time',
            'filename',  // 移除通用filename字段
            'file'       // 移除文件路径字段
        ]);

        return data.map(item => {
            // 创建清理后的记录
            const cleanedItem = {};
            for (const [key, value] of Object.entries(item)) {
                if (!internalFields.has(key)) {
                    cleanedItem[key] = value;
                }
            }
            return cleanedItem;
        });
    }

    // --- 获取保持原始顺序的表头（仅用于显示） ---
    function getOriginalOrderHeaders(data, mode = 'sn') {
        if (!data || data.length === 0) return [];

        // 先清理显示数据
        const cleanedData = cleanDisplayData(data);
        if (cleanedData.length === 0) return [];

        // 根据模式定义字段顺序
        const columnOrders = {
            'ieee': ['订单号', '英文题目', '英文副标', '作者姓名', '第一作者邮箱'],
            'sn': ['Number', 'Title', 'SubTitle', 'Author 1', 'Affiliation 1', 'Author 2', 'Affiliation 2',
                   'Author 3', 'Affiliation 3', 'Author 4', 'Affiliation 4', 'Author 5', 'Affiliation 5',
                   'Corresponding Author', "Corresponding author's email"],
            'funding': ['文件名', '论文英文题目', '第一作者姓名', '第一作者单位', '通讯作者姓名', '通讯作者单位',
                       '通讯作者邮箱', '关键词', '摘要', '致谢'],
            'ap': ['文件名', '题目', '关键词', '摘要', '第一作者姓', '第一作者名', '通讯作者姓', '通讯作者名']
        };

        // 收集所有实际存在的字段
        const allFieldsSet = new Set();
        cleanedData.forEach(row => {
            if (typeof row === 'object' && row !== null) {
                Object.keys(row).forEach(key => allFieldsSet.add(key));
            }
        });

        // 如果有预定义的字段顺序，使用它
        if (columnOrders[mode]) {
            const orderedHeaders = [];
            // 按预定义顺序添加字段
            columnOrders[mode].forEach(col => {
                if (allFieldsSet.has(col)) {
                    orderedHeaders.push(col);
                    allFieldsSet.delete(col);
                }
            });

            // 添加剩余字段
            orderedHeaders.push(...Array.from(allFieldsSet).sort());
            return orderedHeaders;
        }

        // 如果没有预定义顺序，使用第一行的键顺序
        const firstValidRow = cleanedData.find(row => typeof row === 'object' && row !== null);
        if (!firstValidRow) return [];

        const firstRowHeaders = Object.keys(firstValidRow);
        const remainingHeaders = [...allFieldsSet].filter(header => !firstRowHeaders.includes(header));

        return [...firstRowHeaders, ...remainingHeaders];
    }

    // --- 获取列的CSS类 ---
    function getColumnClass(header) {
        const headerLower = header.toLowerCase();

        if (headerLower.includes('文件名') || headerLower.includes('订单号') || headerLower.includes('number')) {
            return 'col-filename';
        } else if (headerLower.includes('题目') || headerLower.includes('title')) {
            return 'col-title';
        } else if (headerLower.includes('作者') && !headerLower.includes('邮箱') && !headerLower.includes('email')) {
            return 'col-author';
        } else if (headerLower.includes('单位') || headerLower.includes('affiliation')) {
            return 'col-affiliation';
        } else if (headerLower.includes('邮箱') || headerLower.includes('email')) {
            return 'col-email';
        } else if (headerLower.includes('关键词') || headerLower.includes('keywords')) {
            return 'col-keywords';
        } else if (headerLower.includes('摘要') || headerLower.includes('abstract')) {
            return 'col-abstract';
        } else if (headerLower.includes('致谢') || headerLower.includes('acknowledgment')) {
            return 'col-acknowledgment';
        } else {
            return 'col-order';
        }
    }

    // --- 判断是否为长文本列 ---
    function isLongTextColumn(header) {
        const headerLower = header.toLowerCase();
        return headerLower.includes('摘要') ||
               headerLower.includes('abstract') ||
               headerLower.includes('致谢') ||
               headerLower.includes('acknowledgment') ||
               headerLower.includes('关键词') ||
               headerLower.includes('keywords') ||
               headerLower.includes('题目') ||
               headerLower.includes('title');
    }


    // --- 在表格中显示结果（逻辑不变，仅配合样式） ---
    function displayResultsInTable(data, mode = 'sn', preserveOrder = true) {
        const thead = resultsTable.querySelector('thead');
        const tbody = resultsTable.querySelector('tbody');

        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            resultsContainer.classList.add('hidden');
            return;
        }

        // 对于显示，清理内部字段但保留所有数据（包括错误的）
        const displayData = cleanDisplayData(data);

        // 根据preserveOrder参数决定是否保持原始顺序
        const headers = preserveOrder ? getOriginalOrderHeaders(data, mode) : getSortedHeaders(displayData, mode);

        // 创建表头行
        const headerRow = document.createElement('tr');
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider ' + getColumnClass(headerText);
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // 创建数据行
        displayData.forEach(rowData => {
            if (typeof rowData !== 'object' || rowData === null) return;
            const row = document.createElement('tr');
            row.className = 'transition-colors';
            headers.forEach(header => {
                const td = document.createElement('td');
                const content = rowData[header] || '';
                const columnClass = getColumnClass(header);

                // 基础样式
                td.className = `text-sm ${columnClass}`;

                // 判断是否为长文本内容
                if (isLongTextColumn(header) && content.length > 100) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'long-text';
                    contentDiv.textContent = content;
                    td.appendChild(contentDiv);
                } else {
                    td.textContent = content;
                }

                row.appendChild(td);
            });
            tbody.appendChild(row);
        });

        resultsContainer.classList.remove('hidden');
    }


    // --- 主处理函数（未改动功能） ---
    async function handleStart() {
        console.log("开始处理按钮被点击");

        const files = pdfFilesInput.files;
        const selectedMode = extractionModeSelect.value;

        if (files.length === 0) {
            alert('请选择要处理的 PDF 文件！');
            return;
        }

        // 重置状态
        startButton.disabled = true;
        downloadLinkContainer.innerHTML = '';
        logContainer.innerHTML = '';
        resultsContainer.classList.add('hidden');
        processedDataForExcel = [];

        const modeNames = {
            'sn': 'SN信息表收集',
            'ieee': 'IEEE信息表收集',
            'funding': '资助信息提取',
            'ap': 'AP信息表收集'
        };

        logMessage(`开始处理 ${files.length} 个文件，使用 ${modeNames[selectedMode]} 模式`);
        statusDiv.textContent = `正在处理 ${files.length} 个文件...`;

        try {
            // 分批上传用户选择的文件
            logMessage('正在上传文件...');

            const batchSize = 20; // 每批上传20个文件，避免单次请求过大
            const totalBatches = Math.ceil(files.length / batchSize);
            let allFilePaths = [];
            let totalUploaded = 0;
            let uploadErrors = [];

            for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                const startIndex = batchIndex * batchSize;
                const endIndex = Math.min(startIndex + batchSize, files.length);
                const batchFiles = Array.from(files).slice(startIndex, endIndex);

                logMessage(`正在上传第 ${batchIndex + 1}/${totalBatches} 批文件 (${batchFiles.length} 个文件)...`);

                const formData = new FormData();
                for (let i = 0; i < batchFiles.length; i++) {
                    formData.append('files', batchFiles[i]);
                }

                try {
                    // 上传当前批次文件到服务器
                    const uploadResponse = await fetch(`${BACKEND_URL}/api/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        throw new Error(`第 ${batchIndex + 1} 批文件上传失败: ${uploadResponse.status} - ${errorText}`);
                    }

                    const uploadResult = await uploadResponse.json();

                    // 检查上传结果
                    if (uploadResult.success) {
                        const batchFilePaths = uploadResult.files.map(file => file.path);
                        allFilePaths = allFilePaths.concat(batchFilePaths);
                        totalUploaded += uploadResult.files.length;

                        // 记录错误信息（如果有的话）
                        if (uploadResult.errors && uploadResult.errors.length > 0) {
                            uploadErrors = uploadErrors.concat(uploadResult.errors);
                        }

                        logMessage(`第 ${batchIndex + 1} 批上传完成: ${uploadResult.files.length} 个文件成功，${uploadResult.errors ? uploadResult.errors.length : 0} 个文件失败`);
                    } else {
                        throw new Error(uploadResult.error || '上传失败');
                    }

                } catch (error) {
                    logMessage(`第 ${batchIndex + 1} 批上传失败: ${error.message}`, 'error');
                    uploadErrors.push({
                        batch: batchIndex + 1,
                        error: error.message
                    });
                }
            }

            // 检查上传结果
            if (allFilePaths.length === 0) {
                throw new Error('所有文件上传都失败了，请检查文件格式和网络连接');
            }

            if (uploadErrors.length > 0) {
                logMessage(`上传完成: ${totalUploaded} 个文件成功，${uploadErrors.length} 个批次失败`, 'warning');
                for (const error of uploadErrors) {
                    logMessage(`批次 ${error.batch} 错误: ${error.error}`, 'error');
                }
            } else {
                logMessage(`所有文件上传完成！总计 ${totalUploaded} 个文件`);
            }

            // 获取所有上传文件的路径
            const filePaths = allFilePaths;
            logMessage(`准备处理 ${filePaths.length} 个文件`);

            // 调用提取API
            logMessage(`正在调用 ${selectedMode} 模式的提取API...`);
            logMessage(`将处理 ${filePaths.length} 个文件，使用 ${filePaths.length > 5 ? '并发' : '串行'} 处理模式`);

            const response = await fetch(`${BACKEND_URL}/api/extract/${selectedMode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_paths: filePaths,
                    use_concurrent: filePaths.length > 5  // 超过5个文件启用并发处理
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API请求失败 (${response.status}): ${errorText}`);
            }

            const result = await response.json();
            logMessage('API调用成功，正在验证和处理结果...');

            // 验证返回结果的格式
            if (!result.success) {
                throw new Error(result.error || '处理请求失败');
            }

            if (!result.results || !Array.isArray(result.results)) {
                throw new Error('服务器返回的数据格式错误');
            }

            // 处理返回的结果
            if (result.results && result.results.length > 0) {
                // 分离成功和失败的结果
                const successfulResults = result.results.filter(r => !r.error && r.status !== 'failed');
                const failedResults = result.results.filter(r => r.error || r.status === 'failed');

                processedDataForExcel = successfulResults; // 只保存成功的结果用于导出

                logMessage(`处理完成: ${successfulResults.length} 个成功，${failedResults.length} 个失败`, 'success');

                // 记录失败的文件
                if (failedResults.length > 0) {
                    logMessage(`失败的文件列表:`, 'warning');
                    failedResults.forEach((failed, index) => {
                        const filename = failed.filename || failed.file || `文件${index + 1}`;
                        const errorMsg = failed.error || '未知错误';
                        logMessage(`  - ${filename}: ${errorMsg}`, 'error');
                    });
                }

                // 显示结果（只显示成功的）
                if (successfulResults.length > 0) {
                    displayResultsInTable(successfulResults, selectedMode);
                    createAndDisplayDownloadButton(selectedMode);
                } else {
                    logMessage('没有成功处理的文件', 'error');
                }

                // 更新状态显示
                if (successfulResults.length > 0) {
                    statusDiv.textContent = `处理完成！成功: ${successfulResults.length}, 失败: ${failedResults.length}`;
                } else {
                    statusDiv.textContent = '处理失败，所有文件都未能成功处理';
                }

                // 显示统计信息
                if (result.statistics) {
                    const stats = result.statistics;
                    logMessage(`统计信息: 总文件数 ${stats.total_files}, 成功 ${stats.successful}, 失败 ${stats.failed}`, 'info');
                    logMessage(`处理时间: ${stats.processing_time}秒, 平均每个文件: ${stats.avg_time_per_file}秒`, 'info');
                }

            } else {
                logMessage('没有返回任何结果', 'warning');
                statusDiv.textContent = '处理完成，但没有返回结果';
            }

        } catch (error) {
            console.error('处理错误:', error);
            logMessage(`处理失败: ${error.message}`, 'error');
            statusDiv.textContent = '处理失败！';
        } finally {
            startButton.disabled = false;
        }
    }
    
    // --- 创建下载按钮（未改动功能） ---
    function createAndDisplayDownloadButton(mode = 'sn') {
        if(processedDataForExcel.length === 0){
             logMessage('没有可供下载的数据。', 'error');
             return;
        }

        const button = document.createElement('button');
        const modeNames = {
            'sn': 'SN信息表收集',
            'ieee': 'IEEE信息表收集',
            'funding': '资助信息提取',
            'ap': 'AP信息表收集'
        };
        const modeText = modeNames[mode] || 'SN';
        button.textContent = `下载 ${modeText} Excel (${processedDataForExcel.length}条记录)`;
        button.className = "btn-secondary w-full text-center block";

        button.onclick = async () => {
            if (processedDataForExcel.length === 0) {
                logMessage('没有数据可供下载。', 'error');
                return;
            }

            try {
                logMessage('正在准备下载文件...', 'info');

                // 调用后端下载接口
                const response = await fetch('/api/download/excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: processedDataForExcel,
                        mode: mode
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '下载失败');
                }

                // 获取文件名
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `${mode}_papers_metadata.xlsx`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                // 下载文件
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                logMessage(`${modeText} Excel 文件已下载完成。`, 'success');
            } catch (error) {
                console.error('下载失败:', error);
                logMessage(`下载失败: ${error.message}`, 'error');
            }
        };
        
        downloadLinkContainer.innerHTML = ''; // 清空旧按钮
        downloadLinkContainer.appendChild(button);
    }

    // --- 事件监听器（未改动功能） ---
    startButton.addEventListener('click', handleStart);

</script>
</body>
</html>
